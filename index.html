<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>feraw preprocessor</title>

  <link rel="stylesheet" href="https://unpkg.com/codemirror@5.65.16/lib/codemirror.css">
  <script src="https://unpkg.com/codemirror@5.65.16/lib/codemirror.js"></script>
  <script src="https://unpkg.com/codemirror@5.65.16/addon/mode/simple.js"></script>
  <script src="./feraw.js"></script>

  <style>

    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 20px;
      background-color: #282828;
      color: #ebdbb2;
    }

    textarea {
      width: 100%;
      height: 300px;
      margin-bottom: 10px;
      border: 2px solid #665c54;
      border-radius: 6px;
      padding: 8px;
      background: #1d2021;
      color: #ebdbb2;
      font-family: monospace;
      resize: vertical;
      outline: none;
      transition: border-color 0.2s ease;
    }

    textarea:focus {
      border-color: #fabd2f;
    }

    .CodeMirror {
      height: 300px;
      margin-bottom: 10px;
      border: 2px solid #665c54;
      border-radius: 6px;
    }

    /* gruvbox-dark theme */
    .cm-s-gruvbox-dark.CodeMirror {
      background: #282828;
      color: #ebdbb2;
    }

    .cm-s-gruvbox-dark .CodeMirror-cursor {
      border-left: 1px solid #fabd2f;
    }

    .cm-s-gruvbox-dark .CodeMirror-linenumber {
      color: #928374;
    }

    .cm-s-gruvbox-dark .CodeMirror-gutters {
      background: #282828;
      border-right: 1px solid #3c3836;
      color: #928374;
    }

    .cm-s-gruvbox-dark .cm-comment {
      color: #928374;
      font-style: italic;
    }

    .cm-s-gruvbox-dark .cm-keyword {
      color: #fb4934;
      font-weight: bold;
    }

    .cm-s-gruvbox-dark .cm-string {
      color: #b8bb26;
    }

    .cm-s-gruvbox-dark .cm-number {
      color: #d3869b;
    }

    .cm-s-gruvbox-dark .cm-variable {
      color: #ebdbb2;
    }

    .cm-s-gruvbox-dark .cm-def {
      color: #fabd2f;
    }

    .cm-s-gruvbox-dark .cm-operator {
      color: #fe8019;
    }

    .cm-s-gruvbox-dark .cm-type {
      color: #8ec07c;
    }

    .cm-s-gruvbox-dark .cm-atom {
      color: #83a598;
    }

    .cm-s-gruvbox-dark .cm-bracket {
      color: #d3869b;
    }

    .cm-s-gruvbox-dark .cm-meta {
      color: #8ec07c;
    }

    .cm-s-gruvbox-dark .cm-error {
      color: #fb4934;
      background-color: rgba(251, 73, 52, 0.2);
    }

    .cm-s-gruvbox-dark .CodeMirror-matchingbracket {
      text-decoration: underline;
      color: #b8bb26;
    }

    .cm-s-gruvbox-dark .CodeMirror-nonmatchingbracket {
      text-decoration: underline;
      color: #fb4934;
    }

    .CodeMirror-scroll {
      overflow-y: auto;
      overflow-x: hidden;
    }

    .CodeMirror-cursor {
      border-left: 1px solid #fabd2f;
    }

    .CodeMirror-cursor-primary {
      border-left: 2px solid #fabd2f;
    }

    .CodeMirror-cursor-secondary {
      border-left: 1px solid #ebdbb2;
    }

    .CodeMirror-placeholder {
      color: #7c6f64;
      opacity: 0.5;
    }

    .CodeMirror-focused .CodeMirror-placeholder {
      opacity: 0.8;
    }
  </style>
</head>
<body>
  <h2>feraw input</h2>
  <textarea id="input" placeholder="input..."></textarea>
  <h2>intermediary feraw code</h2>
  <textarea id="expanded" placeholder="expanded macros..."></textarea>
  <h2>bruter-code output</h2>
  <textarea id="output" placeholder="output..." readonly></textarea>

  <script>
  CodeMirror.defineSimpleMode("feraw", {
    start: [
      {regex: /"(?:[^\\"]|\\.)*"?/, token: "string"},   // strings
      {regex: /\/\/.*/, token: "comment"},              // comments
      {regex: /\b(macro|list|new|push|print|free|string)\b/, token: "keyword"},
      {regex: /\b(Any|Float|Buffer)\b/, token: "atom"}, // types
      {regex: /\b\d+\.\d+\b/, token: "number"},         // floats
      {regex: /\b\d+\b/, token: "number"},              // ints
      {regex: /\b[a-zA-Z_][a-zA-Z0-9_]*\b(?=\s*=)/, token: "def"}, // variable definition
      {regex: /\b[a-zA-Z_][a-zA-Z0-9_]*\b/, token: "variable"},    // fallbacks
      {regex: /[\+\-\*\/=<>!]+/, token: "operator"},    // operators
      {regex: /[\[\]\{\}\(\),\.]/, token: "bracket"}    // punctuation
    ],
    meta: {
      lineComment: "//"
    }
  });

  CodeMirror.defineSimpleMode("bruter", {
    start: [

      // Strings
      {regex: /#[a-zA-Z_][\w\-]*/, token: "string"}, // #name, #teste, etc.

      // Literais numéricos
      {regex: /\b\d+\.\d+\b/, token: "number"}, // floats
      {regex: /\b\d+\b/, token: "number"},      // ints

      // Tipos/literals
      {regex: /\b(Any|Float|Buffer)\b/, token: "atom"},

      // Palavras-chave operacionais (comandos RPN)
      {regex: /\b(salloc|new|push|set|get|free|print|define|rename)\b/, token: "keyword"},

      // Operador "!" de execução
      {regex: /!/, token: "operator"},

      // Parênteses e pontuações (caso apareçam)
      {regex: /[\[\]\(\),\.]/, token: "bracket"},

      // Nomes de variáveis simples (sem #)
      {regex: /\b[a-zA-Z_][\w\-]*\b/, token: "variable"},
    ],
    meta: {
      lineComment: "//"
    }
  });

  const editorInput = CodeMirror.fromTextArea(document.getElementById('input'), {
    lineNumbers: true,
    mode: "feraw",
    theme: "gruvbox-dark"
  });

  const expandedInput = CodeMirror.fromTextArea(document.getElementById('expanded'), {
    lineNumbers: true,
    mode: "feraw",
    theme: "gruvbox-dark"
  });

    const editorOutput = CodeMirror.fromTextArea(document.getElementById('output'), {
    lineNumbers: true,
    mode: "bruter",
    theme: "gruvbox-dark"
  });


    editorInput.on("change", () => {
      const inputCode = editorInput.getValue();
      const compiled = feraw_compile(inputCode);
      const expanded = feraw_expand_all(inputCode);
      editorOutput.setValue(compiled);
      expandedInput.setValue(expanded);
    });
  </script>

</body>
</html>
